<!doctype html>
<html lang="pl">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Spotted Zespol Szkol Technicznych</title>
        <style>
            body {
                font-family: Arial, sans-serif;
                background-color: #f0f0f0;
                min-height: 100vh;
            }

            #posts {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
                gap: 20px;
                padding: 20px;
                max-width: 800px;
                margin: 0 auto;
                margin-top: 0px;
                margin-bottom: 40px;
            }

            sub {
                font-size: 0.8em;
                color: #666;
            }

            .post {
                margin-top: 0px;
                background-color: #fff;
                padding: 20px;
                border-radius: 10px;
                border: 0.5px solid #000;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
                display: flex;
                flex-direction: column;
                justify-content: space-between;
                height: 350px;
                word-wrap: break-word;

                /*calc(1.2rem - (100vw - 200px) / 1000 * 1.2rem);*/
            }

            .post h2 {
                margin-top: 0;
            }

            .post p {
                margin: 0;
                font-size: 120%;
            }

            .post .timestamp {
                margin-top: 30px;
                font-size: 0.8em;
                color: #666;
                margin-top: auto;
            }

            .add-post-button {
                position: sticky;
                margin-top: 10px;
                top: 10px;
                left: 50%;
                transform: translateX(-50%);
                background-color: #ffffff;
                color: #000000;
                border: 1px solid #555555;
                padding: 10px 20px;
                border-radius: 10px;
                cursor: pointer;
                z-index: 1;
            }
            header{
                height: 45px;
                background-color: rgb(231, 231, 231);
                margin: 0;
                padding: 0;
                padding-top: 15px;
                text-align: center;
                color: rgb(79, 79, 79);
            }
            header h1{
                font-size: 150%;
            }
            
        </style>
    </head>
    <body style="padding: 0; margin: 0;">
        <div class="content">

        <header>
            <h1 style="margin: 0; padding: 0;">Spotted szko≈Çy browarowa</h1>
        </header>
        <button class="add-post-button" onclick="window.location.href='/post'">
            Dodaj swoj post!
        </button>
        <div id="posts"></div>
        <script>
            let currentPage = 1;
            let loading = false;
            let allPostsLoaded = false;
            const formatTimestamp = (timestamp) => {
    const date = new Date(timestamp);
    const now = new Date();
    const diff = (now.getTime() - date.getTime()) / 1000;

    // Adjust for local timezone offset in minutes
    const timezoneOffset = now.getTimezoneOffset() * 60000;  // Convert minutes to milliseconds
    const localDate = new Date(date.getTime() - timezoneOffset);  // Adjust timestamp to local time

    if (diff < 60) {
        return "przed chwil ";
    } else if (diff < 3600) {
        return `${Math.floor(diff / 60)} minut temu`;
    } else if (diff < 86400) {
        return `${Math.floor(diff / 3600)} godzin temu`;
    } else {
        return `${Math.floor(diff / 86400)} dni temu`;
    }
};


            const escapeHtml = (str) => {
                const div = document.createElement("div");
                div.innerText = str;
                return div.innerHTML;
            };

            function fetchPosts() {
                if (loading || allPostsLoaded) return;

                loading = true;

                fetch(`/posty?page=${currentPage}`)
                    .then((response) => response.json())
                    .then((posts) => {
                        if (posts.length < 50) {
                            allPostsLoaded = true;
                        }

                        posts.forEach((post) => {
                            const el = document.createElement("div");
                            el.classList.add("post");
                            el.innerHTML = `
                            <sub># ${post.id}</sub>
                            <p>${escapeHtml(post.content)}</p>
                            <p class="timestamp">Dodano ${formatTimestamp(post.timestamp)}</p>
                        `;
                            document.getElementById("posts").appendChild(el);
                        });

                        currentPage++;
                        loading = false;
                    })
                    .catch((error) => {
                        console.error("Error fetching posts:", error);
                        loading = false;
                    });
            }

            function checkScroll() {
                if (
                    !loading &&
                    !allPostsLoaded &&
                    window.innerHeight + window.scrollY >=
                        document.body.offsetHeight - 100
                ) {
                    fetchPosts();
                }
            }

            window.addEventListener("scroll", checkScroll);
            fetchPosts();
        </script>
                </div>
    </body>
    {{ footer|safe }}
</html>
