<!doctype html>
<html lang="pl">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}" type="image/x-icon" />

        <title>Spotted Zespol Szkol Technicznych</title>
        <style>
            body {
                font-family: Arial, sans-serif;
                background-color: #f0f0f0;
                min-height: 100vh;
            }

            #posts {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(700px, 1fr));
                gap: 20px;
                padding: 20px;
                max-width: 800px;
                margin: 0 auto;
                margin-top: 0px;
                margin-bottom: 50px;
            }

            sub {
                font-size: 0.8em;
                color: #666;
            }

            .post {
                margin-top: 0px;
                background-color: #fff;
                padding: 20px;
                border-radius: 10px;
                border: 0.5px solid #000;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
                /*display: flex;
                flex-direction: column;
                justify-content: space-between;*/
                height: 350px;
                word-wrap: break-word;

                /*calc(1.2rem - (100vw - 200px) / 1000 * 1.2rem);*/
            }

            .post h2 {
                margin-top: 0;
            }

            .post p {
                margin: 0;
                font-size: 120%;
            }

            .post .timestamp {
                margin-top: 30px;
                font-size: 0.8em;
                color: #666;
                margin-top: auto;
            }

            .add-post-button {
                position: sticky;
                margin-top: 10px;
                top: 10px;
                left: 50%;
                transform: translateX(-50%);
                background-color: #ffffff;
                color: #000000;
                border: 1px solid #555555;
                padding: 10px 20px;
                border-radius: 10px;
                cursor: pointer;
                z-index: 1;
            }
            header{
                height: 60px;
                background-color: rgb(231, 231, 231);
                margin: 0;
                padding: 0;
                text-align: center;
                color: rgb(79, 79, 79);
            }
            header h1{
                font-size: 150%;
            }
            @media only screen and (max-width: 767px) {
                header h1 {
                    display: none;
                }
            }

        </style>
    </head>
    <body style="padding: 0; margin: 0;">
        <div class="content">

        <header>
            <img src="{{ url_for('static', filename='favicon.ico') }}" style="float: left; height: 60%; margin-left: 12px; margin-top: 12px;" />
            <h1 style="margin: 0; padding: 0; float: left; padding-top: 15px; margin-left: 10px">Spotted szkoły browarowa</h1>
            <button id="zalogujSieBtn">Zaloguj się</button>
            <script>
                        function getSecureData(name) {
    const data = localStorage.getItem(name);
    return data;
}
                document.getElementById("zalogujSieBtn").textContent = getSecureData('username') || "Zaloguj się";
            </script>
            <style>
                #zalogujSieBtn{
                    padding: 5px;
                    float: right;
                    margin-right: 10px;
                    margin-top: 15px;
                }
            </style>
            <script>
                document.getElementById("zalogujSieBtn").addEventListener('click', function(){
                    window.location.href = "/account";
                });
            </script>
        </header>
        <button class="add-post-button" onclick="window.location.href='/post'">
            Dodaj swoj post!
        </button>
        <div id="posts"></div>
        <script>
            async function usunKomentarz(komentarzId) {
    const username = getSecureData('username');

    fetch('/usunKomentarz', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            komentarzId: komentarzId,
            username: await hash(username)
        }),
        credentials: 'include' // Send cookies (JWT token)
    })
    .then(response => {
        if (response.status === 204) {
            // Successfully deleted
            location.reload(); // Reload the page to update comments
        } else if (response.status === 404) {
            alert("Komentarz nie istnieje lub nie należy do Ciebie.");
        } else if (response.status === 400) {
            alert("Błąd autoryzacji. Zaloguj się ponownie.");
        } else {
            alert("Wystąpił nieoczekiwany błąd.");
        }
    })
    .catch(error => {
        console.error("Błąd podczas usuwania komentarza:", error);
        alert("Błąd połączenia z serwerem.");
    });
}

            async function hash(data) {
    console.log("utils.js, hash(), Hashing data: " + data);
    const encoder = new TextEncoder();
    const dataBuffer = encoder.encode(data);

    const hashBuffer = await crypto.subtle.digest("SHA-512", dataBuffer);

    const hashArray = Array.from(new Uint8Array(hashBuffer));
    const hashHex = hashArray.map(byte => byte.toString(16).padStart(2, '0')).join('');

    return hashHex;
}
            let currentPage = 1;
            let loading = false;
            let allPostsLoaded = false;
            const formatTimestamp = (timestamp) => {
                //return timestamp;
    const date = new Date(timestamp);  // Create Date object from timestamp
    const now = new Date();  // Get current date and time
    const diff = (now.getTime() - date.getTime()) / 1000;  // Difference in seconds

    // Time difference checks
    if (diff < 60) {
        return "przed chwilą";
    } else if (diff < 3600) {
        return `${Math.floor(diff / 60)} minut temu`;
    } else if (diff < 86400) {
        return `${Math.floor(diff / 3600)} godzin temu`;
    } else {
        return `${Math.floor(diff / 86400)} dni temu`;
    }
};



            const escapeHtml = (str) => {
                const div = document.createElement("div");
                div.innerText = str;
                return div.innerHTML;
            };

            function fetchPosts() {
                if (loading || allPostsLoaded) return;

                loading = true;

                fetch(`/posty?page=${currentPage}`)
                    .then((response) => response.json())
                    .then((posts) => {
                        if (posts.length < 50) {
                            allPostsLoaded = true;
                        }
                        let i = 0;
posts.forEach(async (post) => {
    let postDivBIG = document.createElement('div');
    document.getElementById("posts").appendChild(postDivBIG);
    i = i + 1;
    let tempI = i;
    const el = document.createElement("div");
    el.classList.add("post");

    // Left: Post content
    const postDiv = document.createElement("div");
    postDiv.style.width = "49%";
    postDiv.style.height = "350px";
    postDiv.style.float = "left";
    postDiv.style.borderRight = "1px black solid";
    postDiv.innerHTML = `
        <sub># ${post.id}</sub>
        <p>${escapeHtml(post.content)}</p>
        <p class="timestamp">Dodano ${formatTimestamp(post.timestamp)}</p>
    `;
    el.appendChild(postDiv);

    // Right: Comments
    const commentsSection = document.createElement("div");
    commentsSection.style.width = "49%";
    commentsSection.style.height = "350px";
    commentsSection.style.float = "right";
    let html = `<input type='text' id='input${tempI}' placeholder='Napisz komentarz...' />`;
// Comments list

if (post.comments && post.comments.length > 0) {
    html += `<div class='comments-list' style='margin-top: 10px; max-height: 260px; overflow-y: auto;'>`;
    // Zakładamy, że funkcja generująca HTML znajduje się w async kontekście
const usernameHash = await hash(getSecureData('username'));

for (const comment of post.comments) {
    html += `
        <div style='margin-bottom: 10px; border-bottom: 1px solid #ccc; padding-bottom: 5px;'>
            <p style='margin: 0; font-size: 90%'>
                <strong>${escapeHtml(comment.personalData || comment.creatorUsername)}</strong>: ${escapeHtml(comment.content)}
            </p>
            <p style='margin: 0; font-size: 70%; color: gray;'>${formatTimestamp(comment.timestamp)}</p>
    `;

    // Show delete button only for the author of the comment
    if (comment.creatorUsername === usernameHash) {
        html += `
            <button onclick="usunKomentarz(${comment.id})" 
                    style="font-size: 70%; color: red; background: none; border: none; cursor: pointer; padding: 0; margin-top: 5px;">
                Usuń komentarz
            </button>
        `;
    }

    html += `</div>`;
}


    html += `</div>`;
} else {
    html += `<br /><br /><br /><br /><br /><br /><br /><br />
        <p style='text-align: center; font-size: 90%'>Bądź pierwszą osobą, która skomentuje ten post.</p>`;
}
    commentsSection.innerHTML = html;
    el.appendChild(commentsSection);
    postDivBIG.appendChild(el);
    let inputElement = document.getElementById("input" + tempI);
    const username = getSecureData('username');
if (!username || username === "null" || username.trim() === "") {
    console.log('disabled');
    inputElement.disabled = true;
    inputElement.setAttribute("placeholder", "Aby móc pisać komentarze, musisz się zalogować.");
} else {
    // Add Enter key listener to submit comment
    inputElement.addEventListener("keypress", async function (event) {
        if (event.key === "Enter") {
            event.preventDefault();
            const message = inputElement.value.trim();
            if (message === "") return;

            fetch("/stworzKomentarz", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    username: await hash(username),
                    wiadomosc: message,
                    postId: post.id
                })
            }).then(response => {
                if (response.status === 201) {
                    location.reload(); // Reload to show new comment
                } else {
                    alert("Błąd przy dodawaniu komentarza.");
                }
            }).catch(error => {
                console.error("Błąd żądania:", error);
            });
        }
    });
}
});
                        currentPage++;
                        loading = false;
                    })
                    .catch((error) => {
                        console.error("Error fetching posts:", error);
                        loading = false;
                    });
            }

            function checkScroll() {
                if (
                    !loading &&
                    !allPostsLoaded &&
                    window.innerHeight + window.scrollY >=
                        document.body.offsetHeight - 100
                ) {
                    fetchPosts();
                }
            }

            window.addEventListener("scroll", checkScroll);
            fetchPosts();
        </script>
        <style>
            input[type='text']{
                padding: 10px;
                border-radius: 8px;
                border: 0;
                width: 95%;
                background-color: #ececec;
            }
        </style>
                </div>
    </body>
    {{ footer|safe }}
</html>
